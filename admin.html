<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR Mobile Accessories - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Admin Layout */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .admin-sidebar {
            width: 250px;
            background: linear-gradient(135deg, #0f2027, #203a43);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .admin-brand {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-brand h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .admin-brand img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        
        .admin-menu {
            padding: 20px 0;
        }
        
        .menu-title {
            padding: 10px 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.8);
            position: relative;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        .menu-badge {
            position: absolute;
            right: 20px;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .admin-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .admin-user {
            display: flex;
            align-items: center;
        }
        
        .admin-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .admin-user-info h4 {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .admin-user-info p {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .card-icon.users {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .card-icon.products {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .card-icon.orders {
            background: rgba(248, 149, 30, 0.1);
            color: var(--warning);
        }
        
        .card-icon.revenue {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        
        .card-icon.messages {
            background: rgba(63, 55, 201, 0.1);
            color: var(--secondary);
        }
        
        .card-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .card-footer {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-outline {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.pending {
            background: rgba(248, 149, 30, 0.1);
            color: var(--warning);
        }
        
        .status.completed {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .status.cancelled {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        
        .status.unread {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .status.read {
            background: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 5px;
            border: none;
        }
        
        .action-btn.view {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .action-btn.edit {
            background: rgba(248, 149, 30, 0.1);
            color: var(--warning);
        }
        
        .action-btn.delete {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        
        .action-btn.reply {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        /* Message Thread Styles */
        .message-thread {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
        }
        
        .message-item {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .message-item.admin {
            background: rgba(67, 97, 238, 0.1);
            border-left: 3px solid var(--primary);
        }
        
        .message-item.user {
            background: rgba(108, 117, 125, 0.1);
            border-left: 3px solid var(--gray);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .message-sender {
            font-weight: 600;
        }
        
        .message-time {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        /* Form Styles */
        .form-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .admin-sidebar .menu-title,
            .admin-sidebar .menu-item span {
                display: none;
            }
            
            .admin-sidebar .menu-item {
                justify-content: center;
                padding: 15px 0;
            }
            
            .admin-sidebar .menu-item i {
                margin-right: 0;
                font-size: 1.3rem;
            }
            
            .admin-main {
                margin-left: 70px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-brand">
                <img src="https://i.ibb.co/mFPrvzHC/0a7ca26b-3215-4990-8d5a-b669b374e12f.png" alt="RR Logo">
                <h2>RR Mobile</h2>
            </div>
            
            <div class="admin-menu">
                <div class="menu-title">Main</div>
                <div class="menu-item active" id="dashboardBtn">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                
                <div class="menu-title">Management</div>
                <div class="menu-item" id="productsBtn">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </div>
                <div class="menu-item" id="categoriesBtn">
                    <i class="fas fa-list"></i>
                    <span>Categories</span>
                </div>
                <div class="menu-item" id="ordersBtn">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Orders</span>
                </div>
                <div class="menu-item" id="usersBtn">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </div>
                <div class="menu-item" id="messagesBtn">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                    <span class="menu-badge" id="unreadMessagesBadge">0</span>
                </div>
                
                <div class="menu-title">Settings</div>
                <div class="menu-item" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="menu-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="admin-header">
                    <div class="admin-title">
                        <h1>Dashboard</h1>
                    </div>
                    <div class="admin-user">
                        <img src="https://i.ibb.co/mFPrvzHC/0a7ca26b-3215-4990-8d5a-b669b374e12f.png" alt="Admin">
                        <div class="admin-user-info">
                            <h4>Admin User</h4>
                            <p>Super Admin</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Users</div>
                            <div class="card-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalUsers">0</div>
                        <div class="card-footer">+10% from last month</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Products</div>
                            <div class="card-icon products">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalProducts">0</div>
                        <div class="card-footer">+5 new products</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Orders</div>
                            <div class="card-icon orders">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalOrders">0</div>
                        <div class="card-footer">+15% from last month</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Messages</div>
                            <div class="card-icon messages">
                                <i class="fas fa-envelope"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalMessages">0</div>
                        <div class="card-footer"><span id="unreadMessagesCount">0</span> unread</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Recent Orders</div>
                        <div class="table-actions">
                            <button class="btn btn-outline">View All</button>
                        </div>
                    </div>
                    
                    <table id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Recent Messages</div>
                        <div class="table-actions">
                            <button class="btn btn-outline">View All</button>
                        </div>
                    </div>
                    
                    <table id="recentMessagesTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Message</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Messages will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="productsSection" style="display: none;">
                <!-- Products content remains the same -->
            </div>
            
            <!-- Categories Section -->
            <div id="categoriesSection" style="display: none;">
                <!-- Categories content remains the same -->
            </div>
            
            <!-- Orders Section -->
            <div id="ordersSection" style="display: none;">
                <!-- Orders content remains the same -->
            </div>
            
            <!-- Users Section -->
            <div id="usersSection" style="display: none;">
                <!-- Users content remains the same -->
            </div>
            
            <!-- Messages Section -->
            <div id="messagesSection" style="display: none;">
                <div class="admin-header">
                    <div class="admin-title">
                        <h1>Messages Management</h1>
                    </div>
                    <div class="admin-user">
                        <img src="https://i.ibb.co/mFPrvzHC/0a7ca26b-3215-4990-8d5a-b669b374e12f.png" alt="Admin">
                        <div class="admin-user-info">
                            <h4>Admin User</h4>
                            <p>Super Admin</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">All Messages</div>
                        <div class="table-actions">
                            <button class="btn btn-outline" id="filterAllBtn">All</button>
                            <button class="btn btn-outline" id="filterUnreadBtn">Unread</button>
                            <button class="btn btn-outline" id="filterPaymentBtn">Payments</button>
                            <button class="btn btn-outline" id="filterOrderBtn">Orders</button>
                            <button class="btn btn-outline" id="filterProblemBtn">Problems</button>
                        </div>
                    </div>
                    
                    <table id="allMessagesTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Message</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- All messages will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settingsSection" style="display: none;">
                <!-- Settings content remains the same -->
            </div>
        </div>
    </div>
    
    <!-- Message Thread Modal -->
    <div class="modal-overlay" id="messageThreadModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Message Thread</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <div id="messageThreadContent">
                    <div class="message-user-info">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <img id="messageUserImage" src="" alt="User" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                            <div>
                                <h3 id="messageUserName" style="margin-bottom: 5px;"></h3>
                                <div style="display: flex; gap: 10px;">
                                    <span id="messageUserEmail" style="font-size: 0.9rem; color: var(--gray);"></span>
                                    <span id="messageUserPhone" style="font-size: 0.9rem; color: var(--gray);"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="message-thread" id="messageThread">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <form id="replyMessageForm">
                        <div class="form-group">
                            <label class="form-label">Your Reply</label>
                            <textarea class="form-control" id="replyMessage" required></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="button" class="btn btn-outline" id="closeMessageThreadBtn">Close</button>
                            <button type="submit" class="btn btn-primary">Send Reply</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBOlLzr0liPHXEssNXSpY8XozoYPPEeA60",
            authDomain: "rr-mobile-accessories.firebaseapp.com",
            databaseURL: "https://rr-mobile-accessories-default-rtdb.firebaseio.com",
            projectId: "rr-mobile-accessories",
            storageBucket: "rr-mobile-accessories.appspot.com",
            messagingSenderId: "261034064103",
            appId: "1:261034064103:web:b59fbb7118dd7f93868a42",
            measurementId: "G-28RJEQ3X7H"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // DOM Elements
        const dashboardBtn = document.getElementById('dashboardBtn');
        const productsBtn = document.getElementById('productsBtn');
        const categoriesBtn = document.getElementById('categoriesBtn');
        const ordersBtn = document.getElementById('ordersBtn');
        const usersBtn = document.getElementById('usersBtn');
        const messagesBtn = document.getElementById('messagesBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const dashboardSection = document.getElementById('dashboardSection');
        const productsSection = document.getElementById('productsSection');
        const categoriesSection = document.getElementById('categoriesSection');
        const ordersSection = document.getElementById('ordersSection');
        const usersSection = document.getElementById('usersSection');
        const messagesSection = document.getElementById('messagesSection');
        const settingsSection = document.getElementById('settingsSection');
        
        const unreadMessagesBadge = document.getElementById('unreadMessagesBadge');
        const unreadMessagesCount = document.getElementById('unreadMessagesCount');
        const totalMessages = document.getElementById('totalMessages');
        
        const recentMessagesTable = document.getElementById('recentMessagesTable').getElementsByTagName('tbody')[0];
        const allMessagesTable = document.getElementById('allMessagesTable').getElementsByTagName('tbody')[0];
        
        const messageThreadModal = document.getElementById('messageThreadModal');
        const messageThread = document.getElementById('messageThread');
        const replyMessageForm = document.getElementById('replyMessageForm');
        const closeMessageThreadBtn = document.getElementById('closeMessageThreadBtn');
        
        const filterAllBtn = document.getElementById('filterAllBtn');
        const filterUnreadBtn = document.getElementById('filterUnreadBtn');
        const filterPaymentBtn = document.getElementById('filterPaymentBtn');
        const filterOrderBtn = document.getElementById('filterOrderBtn');
        const filterProblemBtn = document.getElementById('filterProblemBtn');
        
        // Global variables
        let currentUser = null;
        let messages = [];
        let users = [];
        let currentMessageThread = null;
        let currentMessageUser = null;
        
        // Initialize the admin panel
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    currentUser = user;
                    loadData();
                }
            });
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Load all data from Firebase
        function loadData() {
            // Load users
            database.ref('users').on('value', (snapshot) => {
                users = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.id = childSnapshot.key;
                    users.push(user);
                });
                
                document.getElementById('totalUsers').textContent = users.length;
            });
            
            // Load messages
            database.ref('messages').orderByChild('timestamp').on('value', (snapshot) => {
                messages = [];
                recentMessagesTable.innerHTML = '';
                allMessagesTable.innerHTML = '';
                
                let unreadCount = 0;
                let totalCount = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    message.id = childSnapshot.key;
                    messages.push(message);
                    
                    // Count unread admin messages
                    if (message.type === 'admin' && message.status === 'unread') {
                        unreadCount++;
                    }
                    
                    totalCount++;
                    
                    // Add to recent messages table (first 5)
                    if (recentMessagesTable.rows.length < 5) {
                        addMessageToTable(message, recentMessagesTable);
                    }
                    
                    // Add to all messages table
                    addMessageToTable(message, allMessagesTable);
                });
                
                // Update counters
                unreadMessagesBadge.textContent = unreadCount;
                unreadMessagesCount.textContent = unreadCount;
                totalMessages.textContent = totalCount;
            });
        }
        
        // Add message to table
        function addMessageToTable(message, table) {
            const row = table.insertRow();
            
            // Find user
            const user = users.find(u => u.id === message.userId) || {};
            
            // User info
            const userCell = row.insertCell(0);
            userCell.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin-right: 10px; overflow: hidden;">
                        ${user.photoURL ? 
                            `<img src="${user.photoURL}" alt="${user.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<span style="font-size: 1rem;">${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</span>`
                        }
                    </div>
                    <div>
                        <div style="font-weight: 500;">${user.name || 'Unknown User'}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">${message.userId.substring(0, 8)}</div>
                    </div>
                </div>
            `;
            
            // Message preview
            const messageCell = row.insertCell(1);
            messageCell.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 3px;">${message.subject || 'No subject'}</div>
                <div style="font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">
                    ${message.message}
                </div>
            `;
            
            // Message type
            const typeCell = row.insertCell(2);
            typeCell.innerHTML = `
                <span class="status ${message.type}">${message.type}</span>
            `;
            
            // Message status
            const statusCell = row.insertCell(3);
            statusCell.innerHTML = `
                <span class="status ${message.status}">${message.status}</span>
            `;
            
            // Date
            const dateCell = row.insertCell(4);
            const messageDate = new Date(message.timestamp);
            dateCell.textContent = messageDate.toLocaleString();
            
            // Actions
            const actionCell = row.insertCell(5);
            actionCell.innerHTML = `
                <button class="action-btn view" data-id="${message.id}"><i class="fas fa-eye"></i></button>
                <button class="action-btn reply" data-id="${message.id}"><i class="fas fa-reply"></i></button>
            `;
            
            // Highlight unread messages
            if (message.status === 'unread' && message.type === 'admin') {
                row.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
            }
        }
        
        // Show message thread
        function showMessageThread(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) return;
            
            currentMessageThread = message;
            
            // Find user
            const user = users.find(u => u.id === message.userId) || {};
            currentMessageUser = user;
            
            // Update user info
            document.getElementById('messageUserImage').src = user.photoURL || 'https://i.ibb.co/mFPrvzHC/0a7ca26b-3215-4990-8d5a-b669b374e12f.png';
            document.getElementById('messageUserName').textContent = user.name || 'Unknown User';
            document.getElementById('messageUserEmail').textContent = user.email || 'No email';
            document.getElementById('messageUserPhone').textContent = user.phone || 'No phone';
            
            // Load message thread
            database.ref('messageThreads/' + message.threadId).orderByChild('timestamp').on('value', (snapshot) => {
                messageThread.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const threadMessage = childSnapshot.val();
                    addMessageToThread(threadMessage);
                });
                
                // Mark as read if it's an admin message
                if (message.type === 'admin' && message.status === 'unread') {
                    database.ref('messages/' + message.id + '/status').set('read');
                }
                
                // Scroll to bottom
                messageThread.scrollTop = messageThread.scrollHeight;
            });
            
            messageThreadModal.classList.add('active');
        }
        
        // Add message to thread
        function addMessageToThread(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item ${message.sender === 'admin' ? 'admin' : 'user'}`;
            
            const messageDate = new Date(message.timestamp);
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${message.sender === 'admin' ? 'Admin' : currentMessageUser.name || 'User'}</span>
                    <span class="message-time">${messageDate.toLocaleString()}</span>
                </div>
                <div class="message-content">${message.message}</div>
            `;
            
            messageThread.appendChild(messageDiv);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            dashboardBtn.addEventListener('click', () => {
                showSection(dashboardSection);
                setActiveNav(dashboardBtn);
            });
            
            productsBtn.addEventListener('click', () => {
                showSection(productsSection);
                setActiveNav(productsBtn);
            });
            
            categoriesBtn.addEventListener('click', () => {
                showSection(categoriesSection);
                setActiveNav(categoriesBtn);
            });
            
            ordersBtn.addEventListener('click', () => {
                showSection(ordersSection);
                setActiveNav(ordersBtn);
            });
            
            usersBtn.addEventListener('click', () => {
                showSection(usersSection);
                setActiveNav(usersBtn);
            });
            
            messagesBtn.addEventListener('click', () => {
                showSection(messagesSection);
                setActiveNav(messagesBtn);
            });
            
            settingsBtn.addEventListener('click', () => {
                showSection(settingsSection);
                setActiveNav(settingsBtn);
            });
            
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            });
            
            // Show section
            function showSection(section) {
                dashboardSection.style.display = 'none';
                productsSection.style.display = 'none';
                categoriesSection.style.display = 'none';
                ordersSection.style.display = 'none';
                usersSection.style.display = 'none';
                messagesSection.style.display = 'none';
                settingsSection.style.display = 'none';
                
                section.style.display = 'block';
            }
            
            // Set active nav
            function setActiveNav(btn) {
                dashboardBtn.classList.remove('active');
                productsBtn.classList.remove('active');
                categoriesBtn.classList.remove('active');
                ordersBtn.classList.remove('active');
                usersBtn.classList.remove('active');
                messagesBtn.classList.remove('active');
                settingsBtn.classList.remove('active');
                
                btn.classList.add('active');
            }
            
            // View message thread
            document.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn.view')) {
                    const messageId = e.target.closest('.action-btn.view').dataset.id;
                    showMessageThread(messageId);
                }
                
                // Reply to message
                if (e.target.closest('.action-btn.reply')) {
                    const messageId = e.target.closest('.action-btn.reply').dataset.id;
                    showMessageThread(messageId);
                }
            });
            
            // Close message thread
            closeMessageThreadBtn.addEventListener('click', () => {
                messageThreadModal.classList.remove('active');
            });
            
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    messageThreadModal.classList.remove('active');
                });
            });
            
            // Send reply
            replyMessageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const replyText = document.getElementById('replyMessage').value.trim();
                if (!replyText) return;
                
                const replyData = {
                    message: replyText,
                    sender: 'admin',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Add to message thread
                database.ref('messageThreads/' + currentMessageThread.threadId).push(replyData)
                    .then(() => {
                        // Update last message in messages list
                        database.ref('messages/' + currentMessageThread.id + '/status').set('read');
                        
                        // Create notification for user
                        const notificationData = {
                            userId: currentMessageThread.userId,
                            type: 'message',
                            title: 'New Reply from Admin',
                            message: `You have a new reply regarding: ${currentMessageThread.subject}`,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            read: false,
                            link: `message.html?thread=${currentMessageThread.threadId}`
                        };
                        
                        database.ref('notifications').push(notificationData);
                        
                        // Clear reply field
                        document.getElementById('replyMessage').value = '';
                        
                        // Scroll to bottom
                        messageThread.scrollTop = messageThread.scrollHeight;
                    })
                    .catch(error => {
                        alert('Error sending reply: ' + error.message);
                    });
            });
            
            // Filter buttons
            filterAllBtn.addEventListener('click', () => {
                filterMessages('all');
                setActiveFilter(filterAllBtn);
            });
            
            filterUnreadBtn.addEventListener('click', () => {
                filterMessages('unread');
                setActiveFilter(filterUnreadBtn);
            });
            
            filterPaymentBtn.addEventListener('click', () => {
                filterMessages('payment');
                setActiveFilter(filterPaymentBtn);
            });
            
            filterOrderBtn.addEventListener('click', () => {
                filterMessages('order');
                setActiveFilter(filterOrderBtn);
            });
            
            filterProblemBtn.addEventListener('click', () => {
                filterMessages('problem');
                setActiveFilter(filterProblemBtn);
            });
            
            function setActiveFilter(btn) {
                filterAllBtn.classList.remove('active');
                filterUnreadBtn.classList.remove('active');
                filterPaymentBtn.classList.remove('active');
                filterOrderBtn.classList.remove('active');
                filterProblemBtn.classList.remove('active');
                
                btn.classList.add('active');
            }
        }
        
        // Filter messages
        function filterMessages(type) {
            allMessagesTable.innerHTML = '';
            
            let filteredMessages = messages;
            
            switch(type) {
                case 'unread':
                    filteredMessages = messages.filter(m => m.status === 'unread' && m.type === 'admin');
                    break;
                case 'payment':
                    filteredMessages = messages.filter(m => m.type === 'payment');
                    break;
                case 'order':
                    filteredMessages = messages.filter(m => m.type === 'order');
                    break;
                case 'problem':
                    filteredMessages = messages.filter(m => m.type === 'problem');
                    break;
            }
            
            filteredMessages.forEach(message => {
                addMessageToTable(message, allMessagesTable);
            });
        }
    </script>
</body>
</html>
